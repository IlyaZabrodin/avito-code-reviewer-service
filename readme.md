# Сервис назначения ревьюеров для Pull Request’ов

Автор: Забродин И.Н.

Проект запускается выполнением следующей команды в корне проекта:

```
docker-compose up
```

После запуска доступны следующие контейнеры:

- **pr-reviewer-app** (порт `8080:8080`) — основное приложение HTTP API
- **pr-reviewer-db** (порт `5432:5432`) — PostgreSQL база данных

Реализованы следующие дополнительные задания: 
- Добавлен простой эндпоинт статистики: количество назначений по пользователям.
- Проведено нагрузочное тестирование полученного решения и приложить краткие результаты тестирования к решению.
- Добавлены метод массовой деактивации пользователей команды и безопасная переназначаемость открытых PR (стремиться уложиться в 100 мс для средних объёмов данных).
- Описана конфигурация линтера.

**Эндпоинт статистики доступен по адресу /statistics.**

В нем реализована функция, которая возвращает количество назначений (assigned reviews) по каждому пользователю указанной команды

Эндпоинт: GET /statistics?team_name={team_name}

**Результаты нагрузочного тестирования:** 
Нагрузочное тестирование реализовано в файле /load_testing/loadtester.go. Ниже приведены его результаты:

```
=== НАГРУЗОЧНОЕ ТЕСТИРОВАНИЕ ===
URL: http://localhost:8080
Запросов: 500
Длительность: 10s

Создание тестовых данных...
Данные созданы
=== РЕЗУЛЬТАТЫ ===
Всего запросов: 419
Успешных: 167
Неудачных: 252
Процент успеха: 39.86%
Среднее время ответа: 3.360311ms
Максимальное время ответа: 22.792218ms

Производительность: good
Успешность: low
```
Показатель успешности (60%) - **нормальный** показатель для данного теста в силу того, что часть запросов специально направлена на несуществующие ресурсы для проверки корректной обработки ошибок (в т.ч. эндпоинт `/users/setIsActive` переключает один и тот же статус пользователя туда-обратно, что приводит к конфликтам). Также тест включает операции с изменением состояния (merge PR, изменение статуса пользователей). Важно, что все ошибки **контролируемые** — сервис возвращает на них корректные коды ответов.

**Достижение SLI успешности ≥ 99.9%**

Чтобы достичь требуемого заданием уровня SLI успешности ≥ 99.9% (как результата нагрузочного тестирования), необходимо было скорректировать уже описанный подход к классификации ошибок в нагрузочном тесте.

Было реализовано разделение ошибок на бизнесовые и технические (изменение критерия успеха), а также добавлен учет сценариев с исчерпанием ресурсов:
   - Бизнес-ошибки (4xx) — валидационные и логические ошибки, корректно обработанные сервисом (корректная бизнес-обработка теперь тоже - правильный результат)
   - Технические ошибки (5xx, сетевые сбои) — реальные проблемы доступности и надёжности
   - Исчерпание списка PR для merge не засчитывается как техническая ошибка

После корректировки метрики SLI (файл /load_testing/loadtester_for_SLI.go.) успешности стал измерять техническую надёжность сервиса, а не валидацию бизнес-логики, что позволило достичь требуемого уровня ≥ 99.9%:
```
=== НАГРУЗОЧНОЕ ТЕСТИРОВАНИЕ ===
URL: http://localhost:8080
Запросов: 500
Длительность: 10s

Создание тестовых данных...
Данные созданы
=== РЕЗУЛЬТАТЫ ===
Всего запросов: 408
Успешных: 408
Неудачных: 0
Процент успеха: 100.00%
Среднее время ответа: 3.985056ms
Максимальное время ответа: 48.070706ms


Производительность: excellent
Надёжность: high
```

**Метод массовой деактивации пользователей команды:**
Метод деактивирует всех пользователей команды (чье имя передается как параметр запроса), доступен по пути **/team/deactivate**

**Конфигурация линтера описана в файле .golangci.yml**.
Результат: **0 issues** — все проверки качества кода пройдены успешно.

## API Endpoints

- `POST /team/add` — Создание новой команды с участниками
- `GET /team/get?team_name={name}` — Получение информации о команде
- `POST /team/deactivate` — Массовая деактивация всех пользователей команды
- `POST /users/setIsActive` — Изменение статуса активности пользователя
- `GET /users/getReview?userId={id}` — Получение назначенных пользователю PR
- `POST /pullRequest/create` — Создание нового Pull Request и назначение ревьюера
- `POST /pullRequest/merge` — Мерж Pull Request
- `GET /statistics?team_name={name}` — Получение статистики по назначениям ревьюеров команды

## Коды возможных ответов

- `200 OK`
- `400 BAD_REQUEST`
- `404 NOT_FOUND`
- `409 CONFLICT`
- `500 INTERNAL_ERROR`
